#!/usr/bin/env python

from __future__ import print_function
import argparse
import sys
import yturl

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument(
        "-q", "--quality",
        help='"low", "medium", "high", or an itag',
        default="medium",
    )
    parser.add_argument(
        "url",
        metavar="video_id/url",
        help="a YouTube url (or bare video ID)",
    )
    args = parser.parse_args()

    video_id = yturl.video_id_from_url(args.url)
    desired_itag = yturl.itag_from_quality(args.quality)

    if desired_itag is None:
        print("Unknown quality: " + args.quality, file=sys.stderr)
        sys.exit(2)

    try:
        video_itags = dict(yturl.itags_for_video(video_id))
    except LookupError as err:
        print("YouTube API error: " + str(err), file=sys.stderr)
        sys.exit(3)

    itags_by_similarity = yturl.itags_by_similarity(desired_itag)
    most_similar_available_itag = yturl.most_similar_available_itag(
        itags_by_similarity, video_itags,
    )

    if most_similar_available_itag:
        print("Using itag %s." % most_similar_available_itag, file=sys.stderr)
        print(video_itags[most_similar_available_itag])
    else:
        print("No local itags available.", file=sys.stderr)
        sys.exit(1)
